{% extends 'base.html' %}

{% block content %}
<div class="container-fluid p-4 mt-3">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #28a745;">
                <div class="icon">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_finalizadas }}</div>
                    <div class="label">Finalizadas</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #17a2b8;">
                <div class="icon">
                    <i class="bi bi-gear-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_em_andamento }}</div>
                    <div class="label">Em Andamento</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #e98604;">
                <div class="icon">
                    <i class="bi bi-question-circle-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_aguardando }}</div>
                    <div class="label">Aguardando Parecer</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card-stats" style="background-color: #dc3545;">
                <div class="icon">
                    <i class="bi bi-x-circle-fill"></i>
                </div>
                <div>
                    <div class="number">{{ total_canceladas }}</div>
                    <div class="label">Canceladas</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid p-5 mt-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-center mb-0">LISTA DE ORDENS DE SERVIÇO</h3>
        <a href="{% url 'add_ordem' %}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Nova Ordem de Serviço
        </a>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} fade show" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col" class="text-center">Processo</th>
            <th scope="col" class="text-center">Nome</th>
            <th scope="col" class="text-center">Tipo</th>
            <th scope="col" class="text-center">Endereço</th>
            <th scope="col" class="text-center">Status</th>
            <th scope="col" class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for ordem in ordens %}
          <tr>
            <th scope="row" class="text-center">{{ ordem.processo }}</th>
            <td class="text-center">{{ ordem.nome_solicitante }}</td>
            <td class="text-center">{{ ordem.get_tipo_display }}</td>
            <td class="text-center">{{ ordem.endereco }}</td>
            <td class="text-center">
                {% if ordem.status == 'finalizada' %}
                    <span class="badge badge-success rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">Finalizada</span>
                {% elif ordem.status == 'em_andamento' %}
                    <span class="badge badge-info rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">Em Andamento</span>
                {% elif ordem.status == 'aguardando_parecer' %}
                    <span class="badge badge-warning rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">Aguardando Parecer</span>
                {% elif ordem.status == 'cancelada' %}
                    <span class="badge badge-danger rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">Cancelada</span>
                {% else %}
                    <span class="badge badge-secondary rounded-pill px-4 py-2 fs-6 d-inline-block" style="min-width: 180px; max-width: 180px;">{{ ordem.get_status_display }}</span>
                {% endif %}
            </td>
            <td class="text-center">
                <a href="{% url 'view_ordem' ordem.id %}" class="btn btn-sm btn-link text-info fs-5" title="Visualizar">
                    <i class="bi bi-eye-fill"></i>
                </a>
                <a href="{% url 'edit_ordem' ordem.id %}" class="btn btn-sm btn-link text-primary fs-5" title="Editar">
                    <i class="bi bi-pencil-fill"></i>
                </a>
                <button type="button" class="btn btn-sm btn-link text-danger fs-5" data-bs-toggle="modal" data-bs-target="#deleteModal{{ ordem.id }}" title="Excluir">
                    <i class="bi bi-x-circle-fill"></i>
                </button>
            </td>
          </tr>

          <!-- Modal de Confirmação de Exclusão -->
          <div class="modal fade" id="deleteModal{{ ordem.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ ordem.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteModalLabel{{ ordem.id }}">Confirmar Exclusão</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Tem certeza que deseja excluir a ordem de serviço <strong>{{ ordem.processo }}</strong>?</p>
                  <p class="text-danger">Esta ação não poderá ser desfeita.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <a href="{% url 'delete_ordem' ordem.id %}" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Confirmar Exclusão
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center">Nenhuma ordem de serviço encontrada.</td>
          </tr>
          {% endfor %}
        </tbody>
    </table>

    {% if is_paginated %}
    <nav aria-label="Navegação de páginas" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1" aria-label="Primeira">
              <span aria-hidden="true">&laquo;&laquo;</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Próxima">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Última">
              <span aria-hidden="true">&raquo;&raquo;</span>
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
</div>

<style>
.btn-sm {
    margin-right: 5px;
}

.modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.modal-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.modal-title {
    color: #dc3545;
    font-weight: 600;
}

/* Estilos da paginação */
.pagination .page-link {
    color: #00a652;
    border-color: #00a652;
}

.pagination .page-item.active .page-link {
    background-color: #00a652;
    border-color: #00a652;
    color: white;
}

.pagination .page-link:hover {
    background-color: #00a652;
    border-color: #00a652;
    color: white;
}

.pagination .page-item.disabled .page-link {
    color: #6c757d;
    border-color: #dee2e6;
    background-color: #fff;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fecha automaticamente os alerts após 3 segundos
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            alert.classList.remove('show');
            setTimeout(function() {
                alert.remove();
            }, 150);
        }, 3000);
    });

    // Inicializa todos os modais
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
        new bootstrap.Modal(modal, {
            keyboard: false,
            backdrop: 'static'
        });
    });
});
</script>
{% endblock content %}